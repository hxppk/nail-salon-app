generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  phone     String?
  role      String   @default("CUSTOMER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Member {
  id               String          @id @default(cuid())
  name             String
  phone            String          @unique
  email            String?
  birthday         DateTime?
  gender           String?
  address          String?
  memberDiscount   Float           @default(1.0) // 会员折扣，1.0表示无折扣，0.9表示9折
  rechargeBalance  Float           @default(0)   // 充值余额
  bonusBalance     Float           @default(0)   // 赠金余额
  totalSpent       Float           @default(0)   // 总消费金额
  cashSpent        Float           @default(0)   // 现金消费金额
  visitCount       Int             @default(0)   // 到店次数
  joinDate         DateTime        @default(now())
  lastVisit        DateTime?
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  appointments Appointment[]
  transactions Transaction[]
  orders       Order[]

  @@map("members")
}

model Staff {
  id          String   @id @default(cuid())
  name        String
  phone       String   @unique
  email       String?
  specialties String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  appointments Appointment[]

  @@map("staff")
}

model Service {
  id          String   @id @default(cuid())
  name        String   @unique // 服务项目名称，必填且唯一
  description String?  // 服务描述，可选
  price       Float    // 服务价格，必填
  duration    Int      @default(180) // 服务时长（分钟），默认180分钟
  category    String?  // 服务分类，可选 (如"基础护理"、"美甲设计"等)
  isActive    Boolean  @default(true) // 是否激活
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  appointmentServices AppointmentService[]

  @@map("services")
}

model Appointment {
  id          String            @id @default(cuid())
  memberId    String?           // Optional for non-member appointments
  staffId     String
  customerName String           // For both member and non-member appointments
  customerPhone String          // For both member and non-member appointments
  customerGender String?        // MALE, FEMALE
  guestCount  Int               @default(1) // Number of guests
  maleGuests  Int               @default(0)
  femaleGuests Int              @default(0)
  startTime   DateTime
  endTime     DateTime
  serviceName String            // Service name for display
  duration    Int               @default(180) // Service duration in minutes
  status      String            @default("PENDING") // PENDING, CONFIRMED, ARRIVED, IN_SERVICE, COMPLETED, CANCELLED, OVERDUE
  source      String            @default("MANUAL") // MANUAL, PHONE, APP
  notes       String?
  userNotes   String?           // Customer notes
  merchantNotes String?         // Merchant notes
  totalAmount Float             @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  member   Member?              @relation(fields: [memberId], references: [id], onDelete: SetNull)
  staff    Staff                @relation(fields: [staffId], references: [id])
  services AppointmentService[]
  transactions Transaction[]
  order    Order?

  @@map("appointments")
}

model AppointmentService {
  id            String @id @default(cuid())
  appointmentId String
  serviceId     String

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service     Service     @relation(fields: [serviceId], references: [id])

  @@unique([appointmentId, serviceId])
  @@map("appointment_services")
}

model Transaction {
  id            String          @id @default(cuid())
  memberId      String
  appointmentId String?
  orderId       String?
  type          String          // RECHARGE, CONSUME, POINTS_REDEEM, REFUND
  amount        Float           // 充值金额或消费金额
  giftAmount    Float           @default(0) // 赠金金额，仅在RECHARGE类型时使用
  balanceBefore Float           @default(0)
  balanceAfter  Float           @default(0)
  pointsEarned  Int             @default(0)
  pointsUsed    Int             @default(0)
  paymentMethod String?         // CASH, CARD, ALIPAY, WECHAT, BALANCE
  description   String
  operatorName  String?
  createdAt     DateTime        @default(now())

  member      Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  order       Order?       @relation(fields: [orderId], references: [id])

  @@map("transactions")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Float
  stock       Int      @default(0)
  category    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}

model Order {
  id               String   @id @default(cuid())
  orderNumber      String   @unique // 手工单号
  memberId         String?  // 会员ID（可选，非会员也可开单）
  appointmentId    String?  @unique // 关联预约ID（可选）
  customerName     String   // 顾客姓名
  customerPhone    String   // 顾客手机号
  maleCount        Int      @default(0) // 男性人数
  femaleCount      Int      @default(0) // 女性人数
  source           String   @default("MANUAL") // 顾客来源：MANUAL, PHONE, APP, APPOINTMENT
  totalAmount      Float    // 订单总金额
  discountAmount   Float    @default(0) // 会员折扣金额
  actualAmount     Float    // 实际应付金额（扣除折扣后）
  paidAmount       Float    @default(0) // 已支付金额
  memberDiscount   Float    @default(1.0) // 会员折扣率
  giftDiscountEnabled Boolean @default(true) // 赠金是否参与会员折扣
  deductionOrder   String   @default("GIFT_FIRST") // 扣减方式：GIFT_FIRST, RECHARGE_FIRST
  rechargePaid     Float    @default(0) // 充值余额支付金额
  giftPaid         Float    @default(0) // 赠金余额支付金额
  status           String   @default("PENDING") // PENDING, PAID, CANCELLED
  notes            String?  // 备注
  operatorName     String?  // 操作员姓名
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  member       Member?      @relation(fields: [memberId], references: [id], onDelete: SetNull)
  appointment  Appointment? @relation(fields: [appointmentId], references: [id])
  orderItems   OrderItem[]
  transactions Transaction[]

  @@map("orders")
}

model OrderItem {
  id           String  @id @default(cuid())
  orderId      String
  serviceName  String  // 服务项目名称
  serviceStaff String? // 服务人员
  salesStaff   String? // 销售人员
  unitPrice    Float   // 单价
  quantity     Int     @default(1) // 数量
  subtotal     Float   // 小计金额
  createdAt    DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}


// SQLite does not support enums, using String types instead
// Valid values for reference:
// UserRole: ADMIN, STAFF, CUSTOMER
// Gender: MALE, FEMALE, OTHER
// MembershipLevel: BRONZE, SILVER, GOLD, PLATINUM
// AppointmentStatus: PENDING, CONFIRMED, ARRIVED, IN_SERVICE, COMPLETED, CANCELLED, OVERDUE
// AppointmentSource: MANUAL, PHONE, APP
// TransactionType: RECHARGE, CONSUME, POINTS_REDEEM, REFUND
// PaymentMethod: CASH, CARD, ALIPAY, WECHAT, BALANCE
// OrderStatus: PENDING, PAID, CANCELLED
// OrderSource: MANUAL, PHONE, APP, APPOINTMENT
// DeductionOrder: GIFT_FIRST, RECHARGE_FIRST